<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>Rat in the Hat</title>
        <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
        <!-- Font Awesome icons (free version)-->
        <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
        <!-- Google fonts-->
        <link href="https://fonts.googleapis.com/css?family=Varela+Round" rel="stylesheet" />
        <link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet" />
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="css/styles.css" rel="stylesheet" />
    </head>
    <body id="page-top">
        <!-- Navigation-->
        <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
            <div class="container px-4 px-lg-5">
                <a class="navbar-brand" href="#page-top">Rat in the Hat</a>
                <button class="navbar-toggler navbar-toggler-right" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                    Menu
                    <i class="fas fa-bars"></i>
                </button>
                <div class="collapse navbar-collapse" id="navbarResponsive">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item"><a class="nav-link" href="#about">About</a></li>
                        <li class="nav-item"><a class="nav-link" href="#project">Projects</a></li>
                    </ul>
                </div>
            </div>
        </nav>
        <!-- Masthead-->
        <header class="masthead">
            <div class="container px-4 px-lg-5 d-flex h-100 align-items-center justify-content-center">
                <div class="d-flex justify-content-center">
                    <div class="text-center">
                        <h1 class="mx-auto my-0 text-uppercase">Rat in the Hat</h1>
			    <br>
                        <h3 class="text-white-50 mx-auto mt-2 mb-5">An Embedded Operating Systems final project inspired by <em>Ratatouille</em>.</h3>
                        <h2 class="text-white-50 mx-auto mt-2 mb-5">Stella Han (ch682), Tiffany Guo (tg382)
                            <br>ECE 5725, SP 2023</h2>


                        <a class="btn btn-primary" href="#about">Put Your Chef's Hat on</a>
                    </div>
                </div>
            </div>
        </header>
        <!-- About-->
        <section class="about-section text-center" id="about">
            <div class="container px-4 px-lg-5">
                <div class="row gx-4 gx-lg-5 justify-content-center">
                    <div class="col-lg-8">
                        <h2 class="text-white mb-4">Meet the Chefs</h2>
                    </div>
                </div>
                <!--img class="img-fluid" src="assets/img/ipad.png" alt="..." /-->
                <img class="img-fluid" src="assets/img/ratatouille_team.jpg" alt="Fake chefs" width=50% height=auto />
		    <br><br><br><br><br>
            </div>
        </section>
        <!-- Projects-->
	<section class="projects-section bg-light" id="projects">
	    <div class="container px-4 px-lg-5">
		<h1> Introduction </h1>
		<p> Ratatouille hat in real life. In the 2007 Pixar film Ratatouille, Remy the rat controls Alfredo Linguini’s hand movements via pulling strands of hair on his head. Hiding underneath Linguini’s chef’s hat, Remy guides the talentless chef to cook up many tasty dishes.
                            <br>As untalented chefs, we recreated the hat from the movie in hopes of getting the same experience of being controlled by Remy. 
                                The chef only needs a few pieces of equipment to start cooking: two wristbands and a chef's hat. As the Bluetooth-connected Raspberry Pi 4 inside the hat receives IMU measurements from the two Raspberry Pi Zeros attached to the wristbands, the rat's arm movements will be in sync with those of the chef.
                                The silhouette of the hardworking rat moving its arms will be visible while <em>you</em> are cooking!
		</p>
	    	<img src="assets/img/RemyAndLinguini.gif" alt="Remi and Linguini" width=50% height=auto/>
	    </div>
		<br><br><br>
	    <div class="container px-4 px-lg-5">
		<h1> Design and Testing </h1>
			<p> We divided the project into 3 distinct components: gyroscopes, Bluetooth, and Servo motors. We individually implemented and tested each of these components
				to ensure their functionality before incrementally integrating them into our final prototype.
			</p>
		    <br>
		<h2> Gyroscope </h2>
		    <p> 
			    We received two IMUs from Prof. Skovira, which had 6 degrees of freedom. The code we used to read in the measured data from the 
			    IMUs can be found in the References section of this website. Although we were able to print the measured data on the terminal
			    window without any error, the values seemed to be inconsistent; they did not have any pattern even when we moved the IMU in 
			    one direction. In addition, we observed that the connections between the IMU and the Raspberry Pi 0 board are often disconnected
			    and stopped the program by throwing an error, which we temporarily fixed by implementing a try-except statement and thus skipping
			    the measurement whenever the connections become loose.
		    </p>
		    <p>
			    To fix the inconsistency problem, we searched up the manufacturer’s website on the Internet, and found an Arduino version of 
			    the code written by the manufacturer. We were able to borrow an Arduino Uno board from Prof. Skovira and test if the inconsistency 
			    is resulting from our RPi code or the IMU. We observed that the measurements were consistent when we ran the Arduino code, so we 
			    could conclude that the source of error must be from the RPi code. We soon realized that the IMU was measuring the angular velocities 
			    and not the angles, and added the conversion logic to our code.
		    </p>
		    <code> 
			    np.arctan2(accel_data['y'], accel_data['z']) * 180/np.pi
		    </code>
		    <br>
		    <p>
			    After adding this logic to the code using the numpy library in Python, the RPi code worked in the same way as the Arduino 
			    code was working. We also found out that the loose connections were originating from the soldered pins on the IMU, so we 
			    resoldered the pins to fix the problem. The measurements became consistent and stable after fixing all the issues, and we 
			    were able to move onto the next part of our project.
		    </p>
		    <br>
		    <h2> Bluetooth </h2>
		    <p>
			    One of the most important parts of our project was the bluetooth connections. We first learned basic bluetooth commands in Linux, 
			    such as bluetoothctl, discoverable on, pair on, etc. Then we downloaded the Blue Dot package and used their sample code to establish
			    a connection between one of the RPi 0s and the RPi 4. However, we ran into a problem in which it gave an error message that says the 
			    bluetooth connection already exists, even though we turned off the pairing. We consulted with another group (Jonas Funk and Antti 
			    Meriluoto) in class; they were also using bluetooth between a RPi 4 and a RPi 0, and they recommended using a different bluetooth 
			    library called PyBluez. We were able to use their send/receive code and modify it for our project. EXPLAIN HOW THE CODE WORKS! The
			    link to our send.py and listen.py code files can be found in the Code Appendix section. The PyBluez package had its own GUI to enable
			    bluetooth and connect the devices, which made the setup process much easier.
		    </p>
		    <p>
			    Next, we merged the IMU measurements code into the bluetooth code so we can send the measured data over bluetooth. The data that were 
			    sent from RPi 0 were in the form of a string, and they were converted to floats on the RPi 4 side. We also included a 0.5 seconds 
			    time.sleep() delay to prevent the measurements from being transmitted too quickly, as the servo movements can be less accurate when there
			    are too many values in a short period of time.
		    </p>
		    <p>
			    Finally, we worked on auto-connecting the two RPis at startup and connecting the two RPi 0s with the RPi 4 at the same time.
			    At first, we thought we would need to include extra lines of code to enable the auto-connect, but we discovered that the 
			    devices would connect automatically at startup if they have been paired and stayed connected until the shutdown. To connect
			    two RPi 0s to one RPi 4, we set up two ports on the RPi 4, and stored the data in two different variables. While working on
			    this part, we faced a small problem where the RPi 4 would sometimes be confused with the two ports working simultaneously, 
			    and receive multiple values as one long string. Since each value contained a decimal point, it would fail to convert the long
			    string into a float, and crash the program. We were able to fix this error by filtering out such data; we simply added a 
			    conditional statement so that the variables would store the value only if the length of the transmitted string is less than 
			    30 characters.
		    </p>
		    <h2> Servo motors </h2>
		    <p>
			    We used two 9g micro servos to rotate the rat's arms. The servos had to be small enough to fit behind the rat's body; they 
			    would be part of the shadow otherwise. The servos were positional, and we mapped the angles from the IMUs to be between -1 
			    and 1 to move the servos. We also capped the maximum and minimum angles to be ??? degrees, to prevent the arms from moving 
			    beyond that angle and causing unnatural movements.
		    </p>
		    <p>
			    We used the GPIO pins on RPi 4 for the servos. Since we used PWM and servos in Lab 3 this semester, we were able to reuse our 
			    Lab 3 code to set up the servos.
		    </p>
		    <br>
                                    <!-- HTML generated using hilite.me --><div style="background: #272822; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #f92672">import</span> <span style="color: #f8f8f2">bluetooth</span>
					<span style="color: #f92672">import</span> <span style="color: #f8f8f2">time</span>
					<span style="color: #f92672">from</span> <span style="color: #f8f8f2">mpu6050</span> <span style="color: #f92672">import</span> <span style="color: #f8f8f2">mpu6050</span>
					<span style="color: #f92672">import</span> <span style="color: #f8f8f2">numpy</span> <span style="color: #f92672">as</span> <span style="color: #f8f8f2">np</span>

					<span style="color: #f8f8f2">sensor</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">mpu6050(</span><span style="color: #ae81ff">0x68</span><span style="color: #f8f8f2">)</span>

					<span style="color: #f8f8f2">server_address</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&quot;DC:A6:32:B4:12:B4&quot;</span>

					<span style="color: #f8f8f2">client_socket</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">bluetooth</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">BluetoothSocket(bluetooth</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">RFCOMM)</span>
					<span style="color: #f8f8f2">client_socket</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">connect((server_address,</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">))</span>

					<span style="color: #f8f8f2">begin_time</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">time</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">time()</span>
					<span style="color: #66d9ef">while</span> <span style="color: #f8f8f2">time</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">time()</span> <span style="color: #f92672">&lt;</span> <span style="color: #f8f8f2">begin_time</span> <span style="color: #f92672">+</span> <span style="color: #ae81ff">180</span><span style="color: #f8f8f2">:</span>
					    <span style="color: #66d9ef">try</span><span style="color: #f8f8f2">:</span>
						<span style="color: #f8f8f2">accel_data</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">sensor</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">get_accel_data()</span>
						<span style="color: #f8f8f2">gyro_data</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">sensor</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">get_gyro_data()</span>
						<span style="color: #f8f8f2">temp</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">sensor</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">get_temp()</span>

						<span style="color: #f8f8f2">pitch</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">np</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">arctan2(accel_data[</span><span style="color: #e6db74">&#39;y&#39;</span><span style="color: #f8f8f2">],</span> <span style="color: #f8f8f2">accel_data[</span><span style="color: #e6db74">&#39;z&#39;</span><span style="color: #f8f8f2">])</span> <span style="color: #f92672">*</span> <span style="color: #ae81ff">180</span><span style="color: #f92672">/</span><span style="color: #f8f8f2">np</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">pi</span>
						<span style="color: #66d9ef">print</span><span style="color: #f8f8f2">(pitch)</span>
						<span style="color: #f8f8f2">data</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">pitch</span>
						<span style="color: #f8f8f2">client_socket</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">send(str(data))</span>
						<span style="color: #f8f8f2">time</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">sleep(</span><span style="color: #ae81ff">0.5</span><span style="color: #f8f8f2">)</span>
					    <span style="color: #66d9ef">except</span> <span style="color: #f8f8f2">bluetooth</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">btcommon</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">BluetoothError</span> <span style="color: #66d9ef">as</span> <span style="color: #f8f8f2">error:</span>
						<span style="color: #66d9ef">print</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&quot;Bluetooth connection error:&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">error)</span>
						<span style="color: #66d9ef">break</span>

					<span style="color: #f8f8f2">client_socket</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">close()</span>
					</pre></div>
		    
		    	    </div>
	</section>

        <!-- Footer-->
        <footer class="footer bg-black small text-center text-white-50"><div class="container px-4 px-lg-5">Copyright &copy; Rat in the Hat 2023</div></footer>
        <!-- Bootstrap core JS-->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Core theme JS-->
        <script src="js/scripts.js"></script>
        <!-- * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *-->
        <!-- * *                               SB Forms JS                               * *-->
        <!-- * * Activate your form at https://startbootstrap.com/solution/contact-forms * *-->
        <!-- * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *-->
        <script src="https://cdn.startbootstrap.com/sb-forms-latest.js"></script>
    </body>
</html>
